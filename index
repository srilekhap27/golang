package document

import (
	"context"
	"encoding/base64"
	"fmt"
	"net/url"
	"strings"

	"github.com/aws/aws-lambda-go/events"
	"yourproject/internal/types"
	"yourproject/internal/utils"
	"github.com/aws/aws-sdk-go-v2/service/s3"
)

type DeleteS3ObjectHandler struct {
	S3Client *s3.Client
}

func (h DeleteS3ObjectHandler) HandleRequest(request events.APIGatewayProxyRequest, bucketName string) (events.APIGatewayProxyResponse, error) {
	headers := map[string]string{
		"Content-Type": "application/json",
	}

	source, err := url.PathUnescape(request.PathParameters["source"])
	if err != nil {
		return utils.GenerateErrorResponse(bucketName, "", "Invalid source")
	}

	action, err := url.PathUnescape(request.PathParameters["action"])
	if err != nil {
		return utils.GenerateErrorResponse(bucketName, "", "Invalid action")
	}

	baseEncodedDocumentTitle, err := url.PathUnescape(request.PathParameters["baseEncodedDocumentTitle"])
	if err != nil {
		return utils.GenerateErrorResponse(bucketName, "", "Invalid baseEncodedDocumentTitle")
	}

	var objectKey string

	if source != "" && action != "" && baseEncodedDocumentTitle != "" {
		decodedKey, err := base64.URLEncoding.DecodeString(baseEncodedDocumentTitle)
		if err != nil {
			return utils.GenerateErrorResponse(bucketName, "", "Invalid objectKey")
		}
		objectKey = strings.TrimSpace(fmt.Sprintf("%s/%s/%s", source, action, string(decodedKey)))
	}

	if objectKey == "" {
		return utils.GenerateErrorResponse(bucketName, objectKey, "object key is passed as nil")
	}

	_, err = h.S3Client.GetObject(context.TODO(), &s3.GetObjectInput{
		Bucket: &bucketName,
		Key:    &objectKey,
	})
	if err != nil {
		return utils.GenerateErrorResponse(bucketName, objectKey, fmt.Sprintf("%s: Object does not exist in the bucket", err.Error()))
	}

	_, err = h.S3Client.DeleteObject(context.TODO(), &s3.DeleteObjectInput{
		Bucket: &bucketName,
		Key:    &objectKey,
	})
	if err != nil {
		return utils.GenerateErrorResponse(bucketName, objectKey, fmt.Sprintf("Error deleting %s: %v", objectKey, err.Error()))
	}

	return utils.GenerateSuccessResponse(bucketName, "", fmt.Sprintf("Deleted %s successfully", objectKey), headers)
}
